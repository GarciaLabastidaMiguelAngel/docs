sequenceDiagram
autonumber

actor U as User/Channel
participant GW as API_Connect_GW
participant MS as API_Cards_Microservice
participant PKM as PKM (Public Key Management)
participant LOC as CardPlaceLocator
participant ANON as Anonymizer_API
participant MQIN as IBM_MQ_IN
participant CORE as Core_Gravity (Bank Core)
participant MQOUT as IBM_MQ_OUT
participant DISP as Dispatcher_Service
participant PLARD as Plard_API

%% =========================================================
%% BOOTSTRAP / STARTUP
%% =========================================================
rect rgba(230,230,230,0.35)
Note over MS: BOOTSTRAP (startup)
MS->>MS: Load config/secrets\n- clientId allowlist\n- Redis channel prefix\n- MQ params\n- timeouts/retries\n- PKM issuer/audience
MS->>PKM: Fetch JWKS (issuer public keys)
PKM-->>MS: JWKS (kid -> publicKey)
MS->>MS: Cache JWKS in-memory\n(refresh/rotation)
MS->>MS: Init crypto providers + observability\n(tracing/metrics/audit)
MS->>MS: Redis SUBSCRIBE\nchannel = redis:trx:reply:<ms-instance>
MS->>MQIN: MQ connectivity check / health
Note over DISP: Dispatcher already running
DISP->>MQOUT: BOOTSTRAP subscribe/consume\n(from MQ OUT queue/topic)
end

%% =========================================================
%% REQUEST FLOW
%% =========================================================
U->>GW: GET /card_transactions?... (card_id, params)\nHeaders: Authorization(JWSID/JWT), x-santander-client-id
Note over GW: SECURITY @ GATEWAY\n1) TLS/mTLS (si aplica)\n2) Validate token signature (PKM JWKS)\n3) Validate claims: iss/aud/exp/nbf\n4) Validate client-id allowlist\n5) Rate limit / WAF / threat protections
GW->>MS: Forward request\n+ propagated correlation-id\n+ validated principal/claims (según estándar interno)

Note over MS: App-level security (defensa en profundidad)\n- re-validate mandatory claims\n- validate scopes/entitlements\n- input validation

MS->>LOC: Resolve card location by card_id
LOC-->>MS: location = PAMPA | PLARD

alt location == PAMPA (Gravity / TRX path)
    Note over MS: PAMPA requiere PAN\n=> desanonimizar CARID -> PAN (NO es DDF)
    MS->>ANON: De-anonymize(card_id)\n(authn between services)
    ANON-->>MS: PAN

    Note over MS: Build TRX request\n- includes PAN + filters/pagination
    MS->>MQIN: Put message(TRX=LWMK/LMWK...)\nheaders: msgId, correlationId, replyTo=MQOUT\nbody: request payload
    MQIN-->>CORE: Deliver TRX request
    CORE-->>MQOUT: TRX response\n(correlationId, status, payload/error)

    Note over DISP: Dispatcher consumes MQ OUT\nand publishes to Redis channel based on correlationId mapping
    DISP->>MQOUT: Consume response (listener)
    DISP->>DISP: Resolve target channel\n(channel = redis:trx:reply:<ms-instance>)
    DISP->>MS: Publish to Redis channel\n(payload + correlationId)

    Note over MS: MS is subscribed since bootstrap\nWait by correlationId (async->sync bridge)
    MS-->>MS: Match correlationId\nassemble API response DTO

    alt TRX error / timeout
        MS-->>GW: Error 4xx/5xx mapped\n(include error code + correlationId)
        GW-->>U: Error response
    else TRX OK
        MS-->>GW: 200/206 response
        GW-->>U: Response
    end

else location == PLARD (API path)
    Note over MS: PLARD se consume por API REST\nNO hay MQ/Dispatcher/Redis PubSub aquí
    %% (Si aplica) desanonimización sólo si PLARD requiere PAN.\n(Si PLARD trabaja por card_id, se omite.)
    MS->>PLARD: GET /v3/card_transactions/transactions\n(params)\nHeaders: auth between services
    alt PLARD error
        MS-->>GW: Error 4xx/5xx mapped\n(include correlationId)
        GW-->>U: Error response
    else PLARD OK
        MS-->>GW: 200/206 response
        GW-->>U: Response
    end
end
